<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title></title>
	<meta charset="utf-8" />
    <title></title>
    <link href="../scripts/webuploader/dist/webuploader.css" rel="stylesheet" />
    <link href="../css/styles1.css" rel="stylesheet" />
    <link href="../scripts/layui/css/layui.css" rel="stylesheet" />
    <link href="../css/font-awesome.min.css" rel="stylesheet" />
    <link href="../css/cmsui.css" rel="stylesheet" />
    <link href="../scripts/layui/css/modules/layer/default/layer.css" rel="stylesheet" />
    <style>
        .valid {
            top: 0px;
            width: 100%;
            text-align: right;
            right: 0px;
            color: rgb(169, 68, 66);
            line-height: 38px;
            padding-right: 20px;
            padding-bottom: 0px;
            font-size: 12px;
            margin-top: 0px;
            display: block;
            position: absolute;
            z-index: 2;
            pointer-events: none;
            animation-duration: 0.2s;
            display: none;
        }
    </style>
</head>
<body>
    <blockquote class="layui-elem-quote">添加景点</blockquote>
    <form name="myForm" class="layui-form layui-form-pane" ng-app="mySpot" ng-controller="spotController">
        <div class="layui-form-item">
            <label class="layui-form-label">景点名称</label>
            <div class="layui-input-inline">
                <input id="SpotName" name="SpotName" class="layui-input" type="text" placeholder="请输入" autocomplete="off" ng-model='SpotName' required>
                <span class="valid" ng-show="myForm.SpotName.$error.required">景点名称不能为空</span>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">经度</label>
            <div class="layui-input-inline">
                <input id="Jd" name="Jd" class="layui-input" type="text" placeholder="请输入,非必填" autocomplete="off">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">纬度</label>
            <div class="layui-input-inline">
                <input id="Wd" name="Wd" class="layui-input" type="text" placeholder="请输入,非必填" autocomplete="off">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">覆盖半径</label>
            <div class="layui-input-inline">
                <input id="Radius" name="Radius" class="layui-input" type="text" placeholder="请输入,非必填" autocomplete="off">
            </div>
        </div>
        <div class="layui-form-item ">
            <label class="layui-form-label">简要介绍</label>

            <div class="layui-input-inline" style="width:80%">
                <div id="introduce" name="content" style="height: 300px;">
                </div>
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">收费信息</label>
            <div class="layui-input-inline" style="width:80%">
                <div id="charge" name="content" style="height: 300px;">
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">开放时间</label>
            <div class="layui-input-inline" style="width:80%">
                <div id="openingtime" name="content" style="height: 300px;">
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">添加附件</label>
            <div class="layui-input-block" style="width:60%">
                <div id="uploader-demo2">
                    <!--用来存放item-->
                    <div id="fileList2" class="uploader-list">
                        <table class="layui-table" lay-skin="line" style="margin:0 0 10px 0px;" id="tbl">
                            <colgroup>
                                <col />
                                <col width="200" />
                                <col width="200" />
                            </colgroup>
                            <thead>
                                <tr style="height:37px;">
                                    <th style="text-align:center;padding:0;">名称</th>
                                    <th style="text-align:center;padding:0;">进度</th>
                                    <th style="text-align:center;padding:0;">操作</th>
                                </tr>
                            </thead>
                            <tbody id="msg"></tbody>
                        </table>
                    </div>
                    <div id="filePicker2" class="layui-inline">选择文件</div>
                    <!--<input type="button" id="ctlBtn2" class="layui-btn layui-btn-primary" value="开始上传" style="position: relative; top: -5px;" />-->
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">排序</label>
            <div class="layui-input-inline">
                <input id="orderid" name="orderid" class="layui-input" placeholder="请输入" autocomplete="off" ng-model='orderid' ng-init="orderid='99'" type="text" ng-pattern="/^[0-9]*$/" required>
                <span class="valid" ng-show="myForm.orderid.$error.required">排序不能为空</span>
                <span class="valid" ng-show="myForm.orderid.$dirty && myForm.orderid.$error.pattern">请输入数字</span>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-input-block">
                <input class="layui-btn layui-btn" data-ng-class="{true:'layui-btn-disabled',false:''}[myForm.$invalid]" data-ng-disabled="myForm.$invalid" type="submit" id="submit" value="提交" />
                <button type="reset" class="layui-btn layui-btn-primary">重置</button>
            </div>
        </div>
    </form>
</body>
</html>
<script src="../scripts/angular.min.js"></script>
<script src="../scripts/layui/layui.js"></script>
<script src="../scripts/jquery-1.10.2.min.js"></script>
<script src="../scripts/layui/lay/modules/layer.js"></script>
<script src="../scripts/model/apiurl.js"></script>
<script src="../scripts/laydate/laydate.js"></script>
<script src="../scripts/datepicker.js"></script>
<script src="../scripts/webuploader/dist/webuploader.js"></script>
<!-- 配置文件 -->
<script src="../scripts/UEditor/ueditor.config.js"></script>
<!-- 编辑器源码文件 -->
<script src="../scripts/UEditor/ueditor.all.js"></script>
<script>
    var CMSUserID = GetCMSData().CMSUserID;
    var angularjs = angular.module('mySpot', []);
    angularjs.controller('spotController', function ($scope) {

    });
    var ue = UE.getEditor('introduce', {
        autoHeightEnabled: true,
        autoFloatEnabled: true,
        //自定义工具
        toolbars: [['fullscreen', 'undo', 'redo', '|',
    'bold', 'italic', 'underline',  'strikethrough', 'removeformat',  '|', 'forecolor', 'backcolor', 'insertorderedlist', 'insertunorderedlist', 'selectall', 'cleardoc', '|',
    'rowspacingtop', 'rowspacingbottom', 'lineheight', '|',
    'customstyle', 'paragraph', 'fontfamily', 'fontsize', '|',
    'justifyleft', 'justifycenter', 'justifyright', 'justifyjustify']]

    });
    var ue2 = UE.getEditor('charge', {
        autoHeightEnabled: true,
        autoFloatEnabled: true,
        toolbars: [['fullscreen', 'undo', 'redo', '|',
    'bold', 'italic', 'underline', 'strikethrough', 'removeformat', '|', 'forecolor', 'backcolor', 'insertorderedlist', 'insertunorderedlist', 'selectall', 'cleardoc', '|',
    'rowspacingtop', 'rowspacingbottom', 'lineheight', '|',
    'customstyle', 'paragraph', 'fontfamily', 'fontsize', '|',
    'justifyleft', 'justifycenter', 'justifyright', 'justifyjustify']]

    });
    var ue3 = UE.getEditor('openingtime', {
        autoHeightEnabled: true,
        autoFloatEnabled: true,
        toolbars: [['fullscreen', 'undo', 'redo', '|',
    'bold', 'italic', 'underline', 'strikethrough', 'removeformat', '|', 'forecolor', 'backcolor', 'insertorderedlist', 'insertunorderedlist', 'selectall', 'cleardoc', '|',
    'rowspacingtop', 'rowspacingbottom', 'lineheight', '|',
    'customstyle', 'paragraph', 'fontfamily', 'fontsize', '|',
    'justifyleft', 'justifycenter', 'justifyright', 'justifyjustify']]

    });
    var HashValue="", AttachUrl, AttachName, AttachNewName, AttachType, Remark, AttachFormat, AttachBytes;
    var jsonData = {
        fileList: []
    };
    var $list2 = $("#fileList2");
    var $btn2 = $("#ctlBtn2");   //开始上传  
    var thumbnailWidth = 100;   //缩略图高度和宽度 （单位是像素），当宽高度是0~1的时候，按照百分比计算
    var thumbnailHeight = 100;
    var uploader2 = WebUploader.create({
        auto: true,
        swf: '../scripts/webuploader/dist/Uploader.swf',
        server: geturl() + '/api/attach/upload',
        pick: '#filePicker2',
        method: 'POST',
        resize: false
    });
    uploader2.on('fileQueued', function (file) {
        var msghtml = "";
        msghtml += "<tr>" +
                    "<td>" + file.name + "</td>" +
                    "<td id='" + file.id + "_pro'></td>" +
                    "<td id='" + file.id + "_do'  style='text-align:center'></td>" +
                    "</tr>";
        $("#msg").append(msghtml);
    });
    uploader2.on('uploadProgress', function (file, percentage) {
        var $li = $('#' + file.id+'_pro'),
        $percent = $li.find('.layui-progress .layui-progress-bar');
        if (!$percent.length) {
            $percent = $('<div class="layui-progress layui-progress-big" lay-showpercent="true">' +
                '<div class="layui-progress-bar layui-bg-red" style="width: 0%;color:white;" id="per"></div>' +
                '</div>' +
            '</div>').appendTo($li).find('.layui-progress-bar');
        }
        $percent.css('width', percentage * 100 + '%');
        //$("#per").html((percentage * 100).toFixed(0) + '%');
    });
    uploader2.on('uploadSuccess', function (file, response) {
        var fileEvent = {
            HashValue: response.Result.HashValue,
            AttachUrl: response.Result.AttachUrl,
            AttachName: response.Result.AttachName,
            AttachNewName: response.Result.AttachNewName,
            AttachType: response.Result.AttachType,
            AttachFormat: response.Result.AttachFormat,
            AttachBytes: response.Result.AttachBytes//,
        };
        jsonData.fileList.push(fileEvent);
        var $lipro = $('#' + file.id + '_pro');
        $lipro.empty().append("上传成功");
        var $li = $('#' + file.id + '_do');
        var dohtml = "<a href='" + fileEvent.AttachUrl + "' target='_blank' class='layui-btn layui-btn-small'>下载</a>" +
                    " <input type='button' value='删除' class='layui-btn layui-btn-small layui-btn-danger' onclick='getdelete(\"" + (jsonData.fileList.length - 1) + "\")'>";
        $li.append(dohtml);
    });
    uploader2.on('uploadError', function (file) {
        var $li = $('#' + file.id),
            $error = $li.find('div.error');
        if (!$error.length) {
            $error = $('<div class="error"></div>').appendTo($li);
        }
        $error.text('上传失败');
    });
    uploader2.on('uploadComplete', function (file) {
        $('#' + file.id).find('.progress').remove();
    });
    $btn2.on('click', function () {
        console.log("上传...");
        uploader2.upload();
    });
    $("#deletePic").click(function () {
        $("#fileList").html("");
        PictureAttach = null;
        $("#deletePic").css('display', 'none');
    });
    $('.valid').css('display', 'block');
    function getdelete(oneFile) {
        layer.confirm("确定要删除该附件？", { icon: 3, title: '提示' }, function (index) {
            jsonData.fileList.splice(oneFile, 1);
            //重新加载
            var msghtml = "";
            for (var i = 0; i < jsonData.fileList.length; i++) {
                msghtml += "<tr>" +
                "<td>" + jsonData.fileList[i].AttachName + "</td>" +
                "<td style='text-align:center'>上传成功</td>" +
                "<td style='text-align:center'><a href='" + jsonData.fileList[i].AttachUrl + "' target='_blank' class='layui-btn layui-btn-small'>下载</a>" +
                " <input type='button' value='删除' class='layui-btn layui-btn-small layui-btn-danger' onclick='getdelete(\"" + i + "\")'></td>" +
                "</tr>";
            }
            $("#msg").empty().append(msghtml);
            layer.closeAll('dialog');
        });
    }

    $("#submit").click(function () {
        var postdata = {
            Name: $("#SpotName").val(),
            Jd: $("#Jd").val(),
            Wd: $("#Wd").val(),
            Radius: $("#Radius").val(),
            Introduce: ue.getContent(),
            Charge: ue2.getContent(),
            OpeningTime: ue3.getContent(),
            OrderID: $("#OrderID").val(),
            CreateUser: CMSUserID,
            Attach: jsonData.fileList
        };
        //alert(JSON.stringify(postdata));
        $.ajax({
            url: "/api/viewspot/add",
            type: "POST",
            data: postdata,
            success: function (data) {
                if (data.Success == 1) {
                    layer.msg("新增景点成功！", { time: 1000 }, function () { location.href = "ViewSpotManager.html"; });
                    layer.closeAll('loading');
                } else {
                    layer.msg("新增景点失败！");
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                layer.msg("数据处理失败！");
                return false;
            }
        });
    });
</script>
